# Panopticlick.org - 终极执行蓝图

> **成败标准**: 如果用户看完后只是觉得"哦，我有指纹"，那是失败的。
> 如果用户**感到后背发凉，立即去检查隐私插件配置**，那才是成功的。

---

## 核心理念：三大情感冲击点

| 冲击点 | 触发机制 | 预期反应 |
|--------|----------|----------|
| **"我值多少钱"** | RTB 模拟器显示 $0.008 | "我被明码标价了？！" |
| **"删不掉的阴影"** | HSTS 超级 Cookie 演示 | "清除数据也没用？！" |
| **"无处躲藏"** | Redacted 解密效果 | "他们居然知道这么多..." |

---

## 完整站点地图 (Sitemap v2.0)

```
panopticlick.org/
│
├── / ─────────────────────── THE MIRROR (首页)
│   │
│   ├── Hero Section
│   │   ├── Headline: "Deconstruct Your Digital Shadow"
│   │   ├── Redacted Preview: "You're browsing from [████████]"
│   │   └── CTA: "Expose Me" (开始扫描)
│   │
│   ├── Live Auction Preview
│   │   ├── RTB Simulator (迷你版)
│   │   ├── "35 advertisers are bidding on you right now"
│   │   └── Live bid ticker animation
│   │
│   ├── Your Market Value Card
│   │   ├── Estimated CPM: $X.XX
│   │   ├── Inferred Persona: [Tech] [Premium] [Travel]
│   │   └── Trackability Score: 94% (EXPOSED)
│   │
│   └── Defense Shield Summary
│       ├── Overall Score: 35/100
│       ├── Quick Status: [AdBlock ✓] [Fingerprint ✗] [DNS ✗]
│       └── CTA: "Fortify Your Defenses →"
│
├── /scan ─────────────────── DEEP SCAN (深度扫描)
│   │
│   ├── Consent Gate
│   │   ├── GDPR Notice
│   │   └── "I consent to this privacy analysis"
│   │
│   ├── Scan Progress
│   │   ├── Phase 1: Collecting fingerprint signals
│   │   ├── Phase 2: Analyzing entropy
│   │   ├── Phase 3: Simulating RTB auction
│   │   └── Phase 4: Testing defenses
│   │
│   └── Full Report
│       ├── Entropy Breakdown (每个信号的位数)
│       ├── Complete RTB Simulation
│       ├── Defense Audit Results
│       └── Downloadable PDF Report
│
├── /anatomy ─────────────── THE ANATOMY (解剖追踪技术)
│   │
│   ├── /anatomy/fingerprint ── 浏览器指纹
│   │   ├── Canvas Fingerprint
│   │   │   ├── Your canvas hash: [████████]
│   │   │   ├── Visual: Actual canvas rendering
│   │   │   └── Entropy: 17.8 bits (1 in 450,000)
│   │   ├── WebGL Fingerprint
│   │   │   ├── GPU: [████████████████]
│   │   │   ├── Renderer: Apple M2 Pro
│   │   │   └── Entropy: 12.3 bits
│   │   ├── Audio Fingerprint
│   │   │   ├── Waveform visualization
│   │   │   └── Entropy: 8.5 bits
│   │   └── Font Enumeration
│   │       ├── Detected fonts: 287
│   │       └── Entropy: 12.5 bits
│   │
│   ├── /anatomy/supercookie ── 超级 Cookie 实验室
│   │   ├── HSTS Supercookie Test
│   │   │   ├── Step 1: "We've planted an ID"
│   │   │   ├── Step 2: "Now clear your cookies"
│   │   │   ├── Step 3: "We still know you"
│   │   │   └── Technical explanation
│   │   ├── Favicon Tracking
│   │   │   └── Demo + explanation
│   │   └── ETag Tracking
│   │       └── Demo + explanation
│   │
│   └── /anatomy/behavior ──── 行为生物识别
│       ├── Mouse Dynamics
│       │   ├── Live tracking visualization
│       │   └── Entropy calculation
│       ├── Scroll Patterns
│       └── Typing Rhythms (optional input)
│
├── /simulation ─────────── THE ADTECH MATRIX (广告技术模拟)
│   │
│   ├── /simulation/rtb ────── RTB 实时竞价 (杀手级)
│   │   ├── Full-screen animated simulation
│   │   ├── Data packet visualization
│   │   ├── Live bid stream
│   │   ├── Winner announcement
│   │   └── "Your data was sold in 85ms"
│   │
│   ├── /simulation/cookie-sync ── Cookie 同步演示
│   │   ├── "How Site A sells your ID to Site B"
│   │   ├── Visual flow diagram
│   │   └── Real cookie sync detection
│   │
│   └── /simulation/cname ──── CNAME 伪装检测
│       ├── Scan current page resources
│       ├── Detect CNAME cloaking
│       └── Show real tracker behind first-party domain
│
├── /defense ─────────────── THE ARMORY (自卫军械库)
│   │
│   ├── /defense/blocker-test ── AdBlock 效能测试
│   │   ├── Bait script matrix
│   │   │   ├── Google Analytics: [BLOCKED ✓]
│   │   │   ├── Facebook Pixel: [LOADED ✗]
│   │   │   └── ... (20+ trackers)
│   │   ├── Score: 85/100
│   │   └── Recommendations
│   │
│   ├── /defense/dns ────────── DNS 隐私检测
│   │   ├── Current DNS provider
│   │   ├── Is DoH/DoT enabled?
│   │   ├── DNS leak test
│   │   └── Recommended DNS providers
│   │
│   ├── /defense/webrtc ─────── WebRTC 泄露检测
│   │   ├── Local IP leak test
│   │   ├── Public IP exposure
│   │   └── Disable instructions
│   │
│   └── /defense/hardening ──── 浏览器加固指南
│       ├── Firefox hardening (about:config)
│       ├── Chrome hardening
│       ├── Safari hardening
│       └── Extension recommendations
│
├── /manifesto ───────────── THE MISSION (使命宣言)
│   │
│   ├── /manifesto/rights ───── 数字隐私权利
│   │   └── Privacy Bill of Rights
│   │
│   └── /manifesto/methodology ── 技术白皮书
│       ├── How we calculate entropy
│       ├── How we estimate CPM
│       └── Data handling practices
│
└── /legal ───────────────── LEGAL
    ├── /privacy ───────────── Privacy Policy
    └── /opt-out ───────────── Delete My Data
```

---

## 页面优先级矩阵

| 优先级 | 页面 | 理由 | 依赖 |
|--------|------|------|------|
| **P0** | `/` (首页) | 第一印象决定一切 | 无 |
| **P0** | `/scan` | 核心功能入口 | 首页 |
| **P0** | `/simulation/rtb` | 杀手级功能 | 首页 |
| **P1** | `/anatomy/fingerprint` | 核心教育内容 | 扫描功能 |
| **P1** | `/anatomy/supercookie` | 震撼演示 | HSTS Worker |
| **P1** | `/defense/blocker-test` | 实用价值 | 诱饵脚本 |
| **P2** | `/simulation/cookie-sync` | 深度教育 | RTB 完成后 |
| **P2** | `/defense/dns` | 补充功能 | 基础完成后 |
| **P2** | `/anatomy/behavior` | 进阶功能 | 基础完成后 |
| **P3** | `/manifesto/*` | 内容页面 | 最后 |
| **P3** | `/defense/hardening` | 静态内容 | 最后 |

---

## 核心组件清单

### 1. 情感核心组件 (Emotional Core)

```
┌─────────────────────────────────────────────────────────────────┐
│                     REDACTED TEXT COMPONENT                      │
│                                                                  │
│  Purpose: Create "classified document" reveal effect             │
│  Impact: Visceral privacy violation moment                       │
│                                                                  │
│  States:                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  REDACTED    │  │  REVEALING   │  │  REVEALED    │          │
│  │  ██████████  │→ │  San Fran... │→ │  San Francisco│         │
│  │  (hover me)  │  │  (decoding)  │  │  (highlighted)│         │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  Usage:                                                          │
│  <RedactedText sensitivity="high">San Francisco, CA</RedactedText>│
└─────────────────────────────────────────────────────────────────┘
```

### 2. 数据可视化组件 (Data Visualization)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ENTROPY GAUGE COMPONENT                       │
│                                                                  │
│  Purpose: Visualize fingerprint uniqueness                       │
│                                                                  │
│                    ╭─────────────────╮                          │
│                   │      18.4       │                          │
│                   │      bits       │                          │
│                    ╰─────────────────╯                          │
│         ═══════════════════════●═══                             │
│         0        10        20     25+                           │
│                                                                  │
│         "1 in 346,000 browsers"                                 │
│                                                                  │
│  Breakdown:                                                      │
│  Canvas    ████████████████████  17.2 bits  [UNIQUE]           │
│  WebGL     ████████████         11.8 bits  [RARE]              │
│  Fonts     ██████████           10.5 bits  [RARE]              │
│  Screen    ███                   4.8 bits  [COMMON]            │
└─────────────────────────────────────────────────────────────────┘
```

### 3. RTB 模拟器组件 (The Killer Feature)

```
┌─────────────────────────────────────────────────────────────────┐
│                    RTB SIMULATOR COMPONENT                       │
│                                                                  │
│  Phase 1: DATA COLLECTION (0-1.5s)                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Collecting your fingerprint...                          │   │
│  │  ████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 35%       │   │
│  │                                                          │   │
│  │  ✓ Canvas    ✓ WebGL    ✓ Audio    ○ Fonts...           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Phase 2: BROADCAST (1.5-3s)                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │     [YOU] ══════▶ [SSP] ══════▶ [EXCHANGE] ══════▶ [DSPs]│   │
│  │                                                          │   │
│  │     ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░  Broadcasting...        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Phase 3: AUCTION (3-6s)                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  INCOMING BIDS                              [47 bidders] │   │
│  │  ───────────────────────────────────────────────────────│   │
│  │  │ The Trade Desk │ Luxury    │ $0.0084 │ ⭐ WINNING   │   │
│  │  │ Meta Audience  │ Tech      │ $0.0072 │              │   │
│  │  │ Google Ads     │ Software  │ $0.0068 │              │   │
│  │  │ Amazon DSP     │ Shopping  │ $0.0061 │              │   │
│  │  │ Criteo         │ Retarget  │ $0.0054 │              │   │
│  │  ───────────────────────────────────────────────────────│   │
│  │                                                          │   │
│  │  Auction completed in 85ms                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Phase 4: RESULT (6s+)                                          │
│  ╔═════════════════════════════════════════════════════════╗   │
│  ║                                                         ║   │
│  ║          YOUR ESTIMATED VALUE: $8.42 CPM                ║   │
│  ║                                                         ║   │
│  ║   "Based on your fingerprint, advertisers are willing   ║   │
│  ║    to pay $8.42 per 1,000 impressions to reach you."    ║   │
│  ║                                                         ║   │
│  ╚═════════════════════════════════════════════════════════╝   │
└─────────────────────────────────────────────────────────────────┘
```

### 4. 防御状态组件 (Defense Status)

```
┌─────────────────────────────────────────────────────────────────┐
│                    DEFENSE RING COMPONENT                        │
│                                                                  │
│                      ╭───────────────╮                          │
│                     ╱                 ╲                         │
│                    │        35        │                         │
│                    │    VULNERABLE    │                         │
│                     ╲                 ╱                         │
│                      ╰───────────────╯                          │
│                                                                  │
│  Color mapping:                                                  │
│  0-39:  RED (VULNERABLE)                                        │
│  40-59: ORANGE (PARTIAL)                                        │
│  60-79: YELLOW (PROTECTED)                                      │
│  80-100: GREEN (HARDENED)                                       │
└─────────────────────────────────────────────────────────────────┘
```

### 5. 超级 Cookie 演示组件 (Supercookie Demo)

```
┌─────────────────────────────────────────────────────────────────┐
│                 HSTS SUPERCOOKIE DEMO COMPONENT                  │
│                                                                  │
│  STEP 1: PLANTING                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  We've assigned you a secret ID:                         │   │
│  │                                                          │   │
│  │       ╔═══════════════════════════════╗                 │   │
│  │       ║      pano_7f3a2b1c            ║                 │   │
│  │       ╚═══════════════════════════════╝                 │   │
│  │                                                          │   │
│  │  This ID has been embedded in your browser's HSTS cache  │   │
│  │  using 32 subdomain requests.                            │   │
│  │                                                          │   │
│  │  [Continue →]                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  STEP 2: ESCAPE ATTEMPT                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Now try to escape:                                      │   │
│  │                                                          │   │
│  │  ☐ Clear all cookies                                     │   │
│  │  ☐ Clear browsing history                                │   │
│  │  ☐ Open incognito window (optional challenge)            │   │
│  │                                                          │   │
│  │  When you're ready, click below.                         │   │
│  │                                                          │   │
│  │  [I've Cleared Everything →]                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  STEP 3: THE REVEAL                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │     ⚠️  WE STILL KNOW WHO YOU ARE                        │   │
│  │                                                          │   │
│  │     Recovered ID: pano_7f3a2b1c ✓                        │   │
│  │                                                          │   │
│  │     Your browser's HSTS cache retained your identity     │   │
│  │     even after you cleared cookies.                      │   │
│  │                                                          │   │
│  │     This is not a bug. This is a feature that real       │   │
│  │     trackers exploit every day.                          │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 6. AdBlock 测试组件 (Blocker Test)

```
┌─────────────────────────────────────────────────────────────────┐
│                   BLOCKER TEST COMPONENT                         │
│                                                                  │
│  YOUR ADBLOCKER EFFECTIVENESS                                   │
│                                                                  │
│         ╭───────────────╮                                       │
│        │      85%      │                                       │
│        │   EFFECTIVE   │                                       │
│         ╰───────────────╯                                       │
│                                                                  │
│  ANALYTICS (3/4 blocked)                                        │
│  ├── Google Analytics    [████████████] BLOCKED ✓               │
│  ├── Google Tag Manager  [████████████] BLOCKED ✓               │
│  ├── Hotjar             [████████████] BLOCKED ✓               │
│  └── Segment            [░░░░░░░░░░░░] LOADED  ✗               │
│                                                                  │
│  ADVERTISING (4/5 blocked)                                      │
│  ├── DoubleClick        [████████████] BLOCKED ✓               │
│  ├── Facebook Pixel     [░░░░░░░░░░░░] LOADED  ✗               │
│  ├── Criteo             [████████████] BLOCKED ✓               │
│  ├── Amazon Ads         [████████████] BLOCKED ✓               │
│  └── The Trade Desk     [████████████] BLOCKED ✓               │
│                                                                  │
│  ⚠️ RECOMMENDATION                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Facebook Pixel and Segment are getting through.          │   │
│  │ Update your filter lists or switch to uBlock Origin.     │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据流架构

### 完整扫描流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           USER'S BROWSER                                 │
│                                                                          │
│  1. User lands on panopticlick.org                                      │
│     │                                                                    │
│     ▼                                                                    │
│  2. Consent banner (GDPR)                                               │
│     │ User clicks "I Consent"                                           │
│     ▼                                                                    │
│  3. POST /api/scan/start                                                │
│     │ ← { sessionId: "sess_abc123" }                                    │
│     ▼                                                                    │
│  4. Run parallel collectors                                             │
│     ┌────────────────────────────────────────────────────────────┐     │
│     │  Promise.allSettled([                                       │     │
│     │    collectCanvas(),      // ~50ms                           │     │
│     │    collectWebGL(),       // ~30ms                           │     │
│     │    collectAudio(),       // ~200ms (slowest)                │     │
│     │    collectFonts(),       // ~100ms                          │     │
│     │    collectScreen(),      // ~5ms                            │     │
│     │    collectTimezone(),    // ~5ms                            │     │
│     │    collectNavigator(),   // ~10ms                           │     │
│     │    collectBehavior(),    // ~10s (optional, background)     │     │
│     │  ])                                                         │     │
│     └────────────────────────────────────────────────────────────┘     │
│     │ Total: ~500ms for core signals                                    │
│     ▼                                                                    │
│  5. Generate hashes locally                                             │
│     │ hardwareHash = SHA-256(canvas|webgl|audio|screen)                │
│     │ softwareHash = SHA-256(ua|fonts|tz|language)                     │
│     ▼                                                                    │
│  6. POST /api/scan/collect                                              │
│     │ Body: { sessionId, fingerprint, hashes }                         │
│     ▼                                                                    │
└─────│───────────────────────────────────────────────────────────────────┘
      │
      │ HTTPS
      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        CLOUDFLARE WORKER                                 │
│                                                                          │
│  7. Validate session                                                    │
│     │ Check KV: session:{sessionId}                                     │
│     │ Check rate limit: ratelimit:{ipHash}                              │
│     ▼                                                                    │
│  8. Enrich with server-side data                                        │
│     │ IP intelligence from CF headers:                                  │
│     │   - cf-connecting-ip → hash for storage                          │
│     │   - cf-ipcountry → US                                            │
│     │   - cf-ipcity → San Francisco                                    │
│     │   - cf-colo → SJC                                                │
│     │                                                                    │
│     │ External API (ipinfo.io batch, optional):                        │
│     │   - ASN, Organization                                            │
│     │   - Proxy/VPN detection                                          │
│     ▼                                                                    │
│  9. Calculate entropy                                                   │
│     │ For each signal:                                                  │
│     │   - Look up frequency in signal_frequencies table                │
│     │   - Calculate: entropy = -log2(frequency/total)                  │
│     │   - Sum all signals for total entropy                            │
│     ▼                                                                    │
│  10. Simulate RTB auction                                               │
│      │ For each mock DSP:                                               │
│      │   - Match persona to interests                                   │
│      │   - Calculate bid = baseRate × multipliers × randomFactor       │
│      │   - Sort bids, select winner                                     │
│      ▼                                                                    │
│  11. Run defense checks                                                 │
│      │ Analyze submitted fingerprint for:                               │
│      │   - Canvas blocking (hash = empty or known spoofed)             │
│      │   - WebGL blocking (renderer = generic)                         │
│      │   - Privacy headers (DNT, GPC from request)                     │
│      ▼                                                                    │
│  12. Store anonymized record                                            │
│      │ INSERT INTO fingerprint_analyses (...)                          │
│      │ UPDATE signal_frequencies (...)                                 │
│      ▼                                                                    │
│  13. Return ValuationReport                                             │
│      │                                                                    │
└──────│──────────────────────────────────────────────────────────────────┘
       │
       │ HTTPS Response
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           USER'S BROWSER                                 │
│                                                                          │
│  14. Receive ValuationReport                                            │
│      │                                                                   │
│      ▼                                                                   │
│  15. Animate results                                                    │
│      │ - Redacted text reveals                                          │
│      │ - Entropy gauge fills                                            │
│      │ - RTB bids stream in                                             │
│      │ - Defense ring calculates                                        │
│      ▼                                                                   │
│  16. User sees their "Digital Shadow"                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### HSTS Supercookie Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      HSTS SUPERCOOKIE MECHANISM                          │
│                                                                          │
│  PHASE 1: ID ENCODING (First Visit)                                     │
│  ═══════════════════════════════════                                    │
│                                                                          │
│  User ID: "pano_7f3a2b1c" → Binary: 0111 1111 0011 1010 ...            │
│                                                                          │
│  For each bit position (0-31):                                          │
│    If bit = 1:                                                          │
│      Request: https://set-{bit}.hsts.panopticlick.org/set               │
│      Response: Strict-Transport-Security: max-age=31536000              │
│                                                                          │
│  Example for ID = 0x7F (binary: 01111111):                              │
│    bit 0 = 1 → https://set-0.hsts.panopticlick.org (HSTS SET)          │
│    bit 1 = 1 → https://set-1.hsts.panopticlick.org (HSTS SET)          │
│    bit 2 = 1 → https://set-2.hsts.panopticlick.org (HSTS SET)          │
│    ...                                                                   │
│    bit 7 = 0 → (no request, HSTS NOT SET)                              │
│                                                                          │
│  PHASE 2: ID RETRIEVAL (Return Visit)                                   │
│  ════════════════════════════════════                                    │
│                                                                          │
│  For each bit position (0-31):                                          │
│    Load image: http://read-{bit}.hsts.panopticlick.org/pixel.gif       │
│                                                                          │
│    If HSTS was set for this subdomain:                                  │
│      Browser auto-upgrades to HTTPS → Image loads → bit = 1            │
│                                                                          │
│    If HSTS was NOT set:                                                 │
│      Request fails (no SSL on HTTP) → Image fails → bit = 0            │
│                                                                          │
│  Reconstruct ID from bits: 01111111 → 0x7F → "pano_7f3a2b1c"           │
│                                                                          │
│  WHY THIS SURVIVES COOKIE CLEARING:                                     │
│  ══════════════════════════════════                                      │
│  - HSTS is stored in browser's HSTS preload list                       │
│  - This is separate from cookies, localStorage, sessionStorage         │
│  - "Clear browsing data" often doesn't clear HSTS                      │
│  - Incognito mode may inherit HSTS state (browser-dependent)           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## API 端点详细设计

### Core Endpoints

```typescript
// ═══════════════════════════════════════════════════════════════
// SCAN ENDPOINTS
// ═══════════════════════════════════════════════════════════════

// POST /api/scan/start
// Initialize a new scan session
Request: {
  consent: boolean;          // Must be true
  referrer?: string;         // Where user came from
}
Response: {
  sessionId: string;         // UUID for this session
  consentRecorded: boolean;
}

// POST /api/scan/collect
// Submit fingerprint and receive analysis
Request: {
  sessionId: string;
  fingerprint: FingerprintPayload;
}
Response: {
  success: boolean;
  analysisId: string;
  report: ValuationReport;
}

// ═══════════════════════════════════════════════════════════════
// RTB SIMULATION ENDPOINTS
// ═══════════════════════════════════════════════════════════════

// POST /api/rtb/simulate
// Run RTB auction simulation
Request: {
  sessionId: string;
  fingerprint: Partial<FingerprintPayload>;
  geo?: { country: string; city: string };
}
Response: {
  success: boolean;
  simulationId: string;
  persona: {
    segment: string;
    tags: string[];
    interests: string[];
  };
  bids: RTBBid[];
  winningBid: RTBBid;
  estimatedCPM: number;
  auctionDuration: number;
}

// ═══════════════════════════════════════════════════════════════
// HSTS SUPERCOOKIE ENDPOINTS
// ═══════════════════════════════════════════════════════════════

// POST /api/supercookie/generate
// Generate a new supercookie ID
Request: {
  sessionId: string;
}
Response: {
  cookieId: string;
  setUrls: string[];         // URLs to request for setting
}

// POST /api/supercookie/verify
// Verify if supercookie can be recovered
Request: {
  sessionId: string;
  recoveredBits: number[];   // Bits recovered from client
}
Response: {
  success: boolean;
  detected: boolean;
  recoveredId: string | null;
  originalId: string;        // What we originally set
  match: boolean;
}

// ═══════════════════════════════════════════════════════════════
// DEFENSE TESTING ENDPOINTS
// ═══════════════════════════════════════════════════════════════

// POST /api/defense/blocker
// Test adblocker effectiveness
Request: {
  sessionId: string;
  results: {
    tracker: string;
    loaded: boolean;
  }[];
}
Response: {
  score: number;             // 0-100
  blocked: number;
  total: number;
  recommendations: string[];
}

// GET /api/defense/dns
// Check DNS configuration
Response: {
  dnsProvider: string;
  isEncrypted: boolean;
  leakDetected: boolean;
  resolverIp: string;
}

// ═══════════════════════════════════════════════════════════════
// STATISTICS ENDPOINTS
// ═══════════════════════════════════════════════════════════════

// GET /api/stats/global
// Get global statistics for comparison
Response: {
  totalScans: number;
  avgEntropy: number;
  medianEntropy: number;
  avgCPM: number;
  avgAdblockScore: number;
  entropyDistribution: EntropyBucket[];
  topBrowsers: BrowserStat[];
  updatedAt: number;
}

// ═══════════════════════════════════════════════════════════════
// PRIVACY ENDPOINTS
// ═══════════════════════════════════════════════════════════════

// POST /api/opt-out
// Delete all data for this IP
Request: {
  confirm: boolean;
}
Response: {
  success: boolean;
  message: string;
}
```

---

## 文件结构最终版

```
panopticlick.org/
│
├── apps/
│   └── web/                              # Next.js Frontend
│       ├── app/
│       │   ├── (marketing)/              # Marketing pages layout
│       │   │   ├── page.tsx              # Homepage (/)
│       │   │   └── layout.tsx
│       │   │
│       │   ├── scan/
│       │   │   ├── page.tsx              # Deep scan page
│       │   │   └── [id]/
│       │   │       └── page.tsx          # Scan results page
│       │   │
│       │   ├── anatomy/
│       │   │   ├── page.tsx              # Anatomy overview
│       │   │   ├── fingerprint/
│       │   │   │   └── page.tsx          # Fingerprint breakdown
│       │   │   ├── supercookie/
│       │   │   │   └── page.tsx          # Supercookie demo
│       │   │   └── behavior/
│       │   │       └── page.tsx          # Behavior analysis
│       │   │
│       │   ├── simulation/
│       │   │   ├── page.tsx              # Simulation overview
│       │   │   ├── rtb/
│       │   │   │   └── page.tsx          # RTB simulator (full)
│       │   │   ├── cookie-sync/
│       │   │   │   └── page.tsx          # Cookie sync demo
│       │   │   └── cname/
│       │   │       └── page.tsx          # CNAME detection
│       │   │
│       │   ├── defense/
│       │   │   ├── page.tsx              # Defense overview
│       │   │   ├── blocker-test/
│       │   │   │   └── page.tsx          # AdBlock test
│       │   │   ├── dns/
│       │   │   │   └── page.tsx          # DNS check
│       │   │   ├── webrtc/
│       │   │   │   └── page.tsx          # WebRTC leak
│       │   │   └── hardening/
│       │   │       └── page.tsx          # Hardening guides
│       │   │
│       │   ├── manifesto/
│       │   │   ├── rights/
│       │   │   │   └── page.tsx          # Privacy rights
│       │   │   └── methodology/
│       │   │       └── page.tsx          # Technical whitepaper
│       │   │
│       │   ├── privacy/
│       │   │   └── page.tsx              # Privacy policy
│       │   │
│       │   ├── opt-out/
│       │   │   └── page.tsx              # Opt-out page
│       │   │
│       │   ├── layout.tsx                # Root layout
│       │   ├── globals.css               # Global styles
│       │   └── error.tsx                 # Error boundary
│       │
│       ├── components/
│       │   ├── ui/                       # shadcn/ui components
│       │   │   ├── button.tsx
│       │   │   ├── card.tsx
│       │   │   ├── progress.tsx
│       │   │   └── ...
│       │   │
│       │   ├── layout/                   # Layout components
│       │   │   ├── header.tsx
│       │   │   ├── footer.tsx
│       │   │   ├── nav.tsx
│       │   │   └── page-layout.tsx
│       │   │
│       │   ├── redacted/                 # Redaction effects
│       │   │   ├── redacted-text.tsx
│       │   │   └── redacted-block.tsx
│       │   │
│       │   ├── scan/                     # Scan components
│       │   │   ├── scan-button.tsx
│       │   │   ├── scan-progress.tsx
│       │   │   ├── consent-gate.tsx
│       │   │   └── results-panel.tsx
│       │   │
│       │   ├── entropy/                  # Entropy visualization
│       │   │   ├── entropy-gauge.tsx
│       │   │   ├── entropy-breakdown.tsx
│       │   │   └── signal-card.tsx
│       │   │
│       │   ├── rtb/                      # RTB simulator
│       │   │   ├── rtb-simulator.tsx
│       │   │   ├── bid-card.tsx
│       │   │   ├── data-packet.tsx
│       │   │   ├── auction-timeline.tsx
│       │   │   └── market-value-card.tsx
│       │   │
│       │   ├── valuation/                # Valuation display
│       │   │   ├── valuation-card.tsx
│       │   │   └── persona-tags.tsx
│       │   │
│       │   ├── defense/                  # Defense components
│       │   │   ├── defense-ring.tsx
│       │   │   ├── blocker-test.tsx
│       │   │   ├── tracker-result.tsx
│       │   │   └── dns-check.tsx
│       │   │
│       │   └── supercookie/              # Supercookie demo
│       │       ├── hsts-demo.tsx
│       │       ├── step-wizard.tsx
│       │       └── reveal-moment.tsx
│       │
│       ├── lib/
│       │   ├── utils.ts                  # Utility functions
│       │   ├── cn.ts                     # Class name helper
│       │   └── api.ts                    # API client
│       │
│       ├── hooks/
│       │   ├── use-fingerprint.ts        # Fingerprint collection hook
│       │   ├── use-rtb.ts                # RTB simulation hook
│       │   ├── use-defense.ts            # Defense testing hook
│       │   ├── use-supercookie.ts        # Supercookie hook
│       │   └── use-reduced-motion.ts     # Accessibility hook
│       │
│       ├── stores/
│       │   ├── scan-store.ts             # Zustand scan state
│       │   └── session-store.ts          # Session management
│       │
│       ├── public/
│       │   ├── fonts/                    # Self-hosted fonts
│       │   │   ├── merriweather/
│       │   │   └── jetbrains-mono/
│       │   ├── bait/                     # AdBlock bait scripts
│       │   │   ├── analytics.js
│       │   │   ├── fbevents.js
│       │   │   └── ...
│       │   └── images/
│       │       └── og-image.png
│       │
│       ├── tailwind.config.ts
│       ├── next.config.js
│       └── package.json
│
├── packages/
│   │
│   ├── fingerprint-sdk/                  # Fingerprint Collection
│   │   ├── src/
│   │   │   ├── index.ts                  # Main export
│   │   │   ├── collector.ts              # Collection orchestrator
│   │   │   ├── hash.ts                   # Hashing utilities
│   │   │   └── collectors/
│   │   │       ├── canvas.ts
│   │   │       ├── webgl.ts
│   │   │       ├── audio.ts
│   │   │       ├── fonts.ts
│   │   │       ├── screen.ts
│   │   │       ├── timezone.ts
│   │   │       ├── navigator.ts
│   │   │       └── behavior.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   ├── valuation-engine/                 # RTB & Entropy
│   │   ├── src/
│   │   │   ├── index.ts
│   │   │   ├── entropy.ts                # Entropy calculation
│   │   │   ├── cpm.ts                    # CPM estimation
│   │   │   ├── persona.ts                # Persona inference
│   │   │   ├── rtb-simulator.ts          # RTB auction simulation
│   │   │   └── data/
│   │   │       ├── dsp-profiles.ts       # Mock DSP data
│   │   │       ├── persona-rules.ts      # Inference rules
│   │   │       └── entropy-table.ts      # Base entropy values
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   └── types/                            # Shared Types
│       ├── src/
│       │   ├── index.ts
│       │   ├── fingerprint.ts
│       │   ├── valuation.ts
│       │   ├── api.ts
│       │   └── defense.ts
│       ├── package.json
│       └── tsconfig.json
│
├── workers/
│   └── api/                              # Cloudflare Worker
│       ├── src/
│       │   ├── index.ts                  # Hono app entry
│       │   ├── routes/
│       │   │   ├── scan.ts               # /api/scan/*
│       │   │   ├── rtb.ts                # /api/rtb/*
│       │   │   ├── supercookie.ts        # /api/supercookie/*
│       │   │   ├── defense.ts            # /api/defense/*
│       │   │   ├── stats.ts              # /api/stats/*
│       │   │   └── optout.ts             # /api/opt-out
│       │   ├── services/
│       │   │   ├── entropy.ts            # Entropy calculation
│       │   │   ├── valuation.ts          # RTB simulation
│       │   │   ├── ip-intel.ts           # IP intelligence
│       │   │   └── storage.ts            # D1 operations
│       │   ├── middleware/
│       │   │   ├── auth.ts               # Session validation
│       │   │   ├── ratelimit.ts          # Rate limiting
│       │   │   └── cors.ts               # CORS handling
│       │   └── types.ts                  # Worker-specific types
│       ├── wrangler.toml
│       └── package.json
│
├── docs/                                 # Documentation
│   ├── ARCHITECTURE.md
│   ├── IMPLEMENTATION.md
│   ├── DATA-SCHEMA.md
│   ├── UI-DESIGN.md
│   ├── FEATURES.md
│   ├── EXECUTION-BLUEPRINT.md            # This file
│   ├── DEVELOPMENT-SEQUENCE.md
│   └── RISK-MITIGATION.md
│
├── migrations/                           # D1 Migrations
│   ├── 001_initial.sql
│   └── 002_indexes.sql
│
├── scripts/                              # Build/Deploy scripts
│   ├── setup.sh
│   └── deploy.sh
│
├── .github/
│   └── workflows/
│       └── deploy.yml                    # CI/CD
│
├── turbo.json                            # Turborepo config
├── pnpm-workspace.yaml                   # pnpm workspaces
├── package.json                          # Root package.json
├── CLAUDE.md                             # Project guide
└── README.md                             # Public readme
```

---

## 关键技术难点预警

### 1. HSTS Supercookie 浏览器兼容性

| 浏览器 | HSTS 持久化 | 隐身模式继承 | 清除方式 |
|--------|------------|-------------|----------|
| Chrome | ✓ | 部分继承 | chrome://net-internals/#hsts |
| Firefox | ✓ | 不继承 | 手动删除或过期 |
| Safari | ✓ | 不继承 | 隐私设置 |
| Edge | ✓ | 部分继承 | 同 Chrome |

**风险**: 浏览器厂商正在逐步封杀这种技术，代码需要定期更新。

### 2. Canvas Fingerprint 反检测

```typescript
// 检测 Canvas 是否被 spoofing
function detectCanvasSpoofing(hash: string): boolean {
  // 已知的 spoofed hash 模式
  const KNOWN_SPOOFED = [
    'CanvasBlocker',           // CanvasBlocker extension
    '00000000',                // All zeros
    'XXXXXXXX',                // Placeholder
  ];

  // Hash 太短说明被截断
  if (hash.length < 32) return true;

  // 匹配已知模式
  if (KNOWN_SPOOFED.some(p => hash.includes(p))) return true;

  return false;
}
```

### 3. AdBlock 误报处理

```typescript
// 多重验证防止误报
async function testTracker(bait: BaitScript): Promise<boolean> {
  // Method 1: Script load test
  const scriptLoaded = await attemptScriptLoad(bait.url);

  // Method 2: Global variable check (if applicable)
  const globalExists = bait.globalCheck
    ? bait.globalCheck in window
    : null;

  // Method 3: Network request test (fetch with no-cors)
  const networkBlocked = await testNetworkRequest(bait.url);

  // Combine results - blocked if ANY method detected blocking
  return !scriptLoaded || globalExists === false || networkBlocked;
}
```

### 4. 动画性能优化

```typescript
// 使用 requestAnimationFrame 而非 setInterval
function animateBidStream(bids: RTBBid[]) {
  let currentIndex = 0;

  function animate() {
    if (currentIndex < bids.length) {
      // Add bid to stream
      addBidToStream(bids[currentIndex]);
      currentIndex++;

      // Schedule next bid with random delay
      setTimeout(() => {
        requestAnimationFrame(animate);
      }, 300 + Math.random() * 200);
    }
  }

  requestAnimationFrame(animate);
}
```

---

## 成功指标 (KPIs)

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 首页跳出率 | < 40% | Cloudflare Analytics |
| 扫描完成率 | > 70% | 完成扫描 / 开始扫描 |
| RTB 模拟器停留时间 | > 2 分钟 | 页面停留时间 |
| Redacted 交互率 | > 80% | 悬停事件 / 访问量 |
| 社交分享率 | > 5% | 分享按钮点击 |
| 回访率 | > 20% | 30天内回访 |
| Lighthouse 分数 | > 90 | Lighthouse CI |
| Core Web Vitals | 全绿 | PageSpeed Insights |
