name = "panopticlick-api"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# Cloudflare Account (DO NOT commit sensitive data here!)
account_id = "201945e73bc3a4f6f77de30504c0687f"

# Development settings
[dev]
port = 8787

# D1 Database - Commented out until created in Cloudflare Dashboard
# [[d1_databases]]
# binding = "DB"
# database_name = "panopticlick"
# database_id = "placeholder-id" # Replace with actual ID after creation

# KV Namespace - Commented out until created in Cloudflare Dashboard
# [[kv_namespaces]]
# binding = "CACHE"
# id = "placeholder-id" # Replace with actual ID after creation

# Analytics Engine - Commented out until needed
# [[analytics_engine_datasets]]
# binding = "ANALYTICS"

# Environment variables
[vars]
ENVIRONMENT = "development"
API_VERSION = "v1"
# Comma-separated list of allowed origins for CORS
ALLOWED_ORIGINS = "http://localhost:3000,https://panopticlick.org"
# Optional Turnstile secret (set in production)
TURNSTILE_SECRET = ""

# AI Chat Configuration (OpenRouter)
# NOTE: DO NOT commit API keys to git!
# Set OPENROUTER_API_KEY as a secret using:
#   npx wrangler secret put OPENROUTER_API_KEY
# Or for local dev, create .dev.vars file with:
#   OPENROUTER_API_KEY=sk-or-v1-your-key-here
# Switched to more stable model (Llama 3.3 70B)
OPENROUTER_MODEL = "meta-llama/llama-3.3-70b-instruct:free"

# Production environment configuration
[env.production]
name = "panopticlick-api"
vars = { ENVIRONMENT = "production", API_VERSION = "v1" }
routes = [
  { pattern = "api.panopticlick.org/*", custom_domain = true }
]

# Rate limiting - ENABLED for production security
# Create rate limiter in Cloudflare Dashboard first, then update namespace_id
[[env.production.unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1001"  # Replace with actual namespace ID from dashboard
simple = { limit = 100, period = 60 }

# Cron triggers for scheduled jobs (stats computation)
[triggers]
crons = ["0 */6 * * *"]  # Run every 6 hours
